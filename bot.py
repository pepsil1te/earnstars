import os
import json
from dotenv import load_dotenv
import telebot
from flask import Flask, jsonify
from flask_cors import CORS
from flask_sqlalchemy import SQLAlchemy
import threading
import base64
import requests

app = Flask(__name__)
CORS(app)

# –ü—É—Ç—å –∫ —Ñ–∞–π–ª—É —Å —Ü–µ–Ω–∞–º–∏
PRICES_FILE = os.path.join(os.path.dirname(__file__), 'config', 'prices.json')

def load_prices():
    """–ó–∞–≥—Ä—É–∂–∞–µ—Ç —Ü–µ–Ω—ã –∏–∑ JSON —Ñ–∞–π–ª–∞"""
    with open(PRICES_FILE, 'r', encoding='utf-8') as f:
        return json.load(f)

def save_prices(prices):
    """–°–æ—Ö—Ä–∞–Ω—è–µ—Ç —Ü–µ–Ω—ã –≤ JSON —Ñ–∞–π–ª"""
    with open(PRICES_FILE, 'w', encoding='utf-8') as f:
        json.dump(prices, f, indent=4, ensure_ascii=False)

@app.route('/prices', methods=['GET'])
def get_prices():
    try:
        return jsonify(load_prices())
    except Exception as e:
        return jsonify({'error': str(e)}), 500

def update_package_price(stars, new_price, new_usd):
    """–û–±–Ω–æ–≤–ª—è–µ—Ç —Ü–µ–Ω—É –ø–∞–∫–µ—Ç–∞ –∑–≤–µ–∑–¥"""
    try:
        prices = load_prices()
        for package in prices['stars']['packages']:
            if package['stars'] == stars:
                package['price'] = new_price
                package['usd'] = new_usd
                save_prices(prices)
                return True
        return False
    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Ü–µ–Ω—ã –ø–∞–∫–µ—Ç–∞: {e}")
        return False

def update_gift_price(gift_id, new_price):
    """–û–±–Ω–æ–≤–ª—è–µ—Ç —Ü–µ–Ω—É –ø–æ–¥–∞—Ä–∫–∞"""
    try:
        prices = load_prices()
        for gift_key, gift_data in prices['gifts'].items():
            if gift_data['id'] == gift_id:
                gift_data['price'] = new_price
                save_prices(prices)
                return True
        return False
    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Ü–µ–Ω—ã –ø–æ–¥–∞—Ä–∫–∞: {e}")
        return False

def update_premium_price(package_id, new_price):
    """–û–±–Ω–æ–≤–ª—è–µ—Ç —Ü–µ–Ω—É –ø—Ä–µ–º–∏—É–º –ø–∞–∫–µ—Ç–∞"""
    try:
        prices = load_prices()
        for package in prices['premium']['packages']:
            if package['id'] == package_id:
                package['price'] = new_price
                save_prices(prices)
                return True
        return False
    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Ü–µ–Ω—ã –ø—Ä–µ–º–∏—É–º –ø–∞–∫–µ—Ç–∞: {e}")
        return False

def get_usd_rate():
    """–ü–æ–ª—É—á–∞–µ—Ç –∞–∫—Ç—É–∞–ª—å–Ω—ã–π –∫—É—Ä—Å USD/RUB —Å –¶–ë –†–§"""
    try:
        response = requests.get('https://www.cbr-xml-daily.ru/daily_json.js')
        if response.ok:
            data = response.json()
            return data['Valute']['USD']['Value']
    except:
        return 90.0  # –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫—É—Ä—Å –µ—Å–ª–∏ API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω

bot = telebot.TeleBot(os.getenv('BOT_TOKEN'))

@bot.message_handler(commands=['start'])
def start(message):
    if message.from_user.id != int(os.getenv('ADMIN_ID')):
        bot.reply_to(message, "–ò–∑–≤–∏–Ω–∏—Ç–µ, —É –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–º—É –±–æ—Ç—É.")
        return
    
    bot.reply_to(message, "–ü—Ä–∏–≤–µ—Ç! –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É /admin –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ü–µ–Ω–∞–º–∏.")

@bot.message_handler(commands=['admin'])
def admin_panel(message):
    if message.from_user.id != int(os.getenv('ADMIN_ID')):
        bot.reply_to(message, "‚ùå –£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏")
        return
    
    markup = telebot.types.InlineKeyboardMarkup(row_width=1)
    markup.add(
        telebot.types.InlineKeyboardButton("üí´ –¶–µ–Ω—ã –Ω–∞ –∑–≤–µ–∑–¥—ã", callback_data="menu_stars"),
        telebot.types.InlineKeyboardButton("üéÅ –¶–µ–Ω—ã –Ω–∞ –ø–æ–¥–∞—Ä–∫–∏", callback_data="menu_gifts"),
        telebot.types.InlineKeyboardButton("üëë –¶–µ–Ω—ã –Ω–∞ Premium", callback_data="menu_premium")
    )
    
    bot.send_message(message.chat.id, "–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–¥–µ–ª –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ü–µ–Ω:", reply_markup=markup)

@bot.callback_query_handler(func=lambda call: call.data.startswith('menu_'))
def handle_menu_selection(call):
    if call.from_user.id != int(os.getenv('ADMIN_ID')):
        bot.answer_callback_query(call.id, "–£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–π —Ñ—É–Ω–∫—Ü–∏–∏")
        return
    
    menu_type = call.data.split('_')[1]
    
    if menu_type == 'stars':
        show_stars_menu(call.message)
    elif menu_type == 'gifts':
        show_gifts_menu(call.message)
    elif menu_type == 'premium':
        show_premium_menu(call.message)
    
    bot.answer_callback_query(call.id)

def show_stars_menu(message):
    prices = load_prices()
    packages = prices['stars']['packages']
    
    markup = telebot.types.InlineKeyboardMarkup(row_width=2)
    for pkg in packages:
        button_text = f"{pkg['stars']} –∑–≤–µ–∑–¥ - {pkg['price']}‚ÇΩ"
        callback_data = f"edit_stars_{pkg['stars']}"
        markup.add(telebot.types.InlineKeyboardButton(text=button_text, callback_data=callback_data))
    
    # –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –≤–æ–∑–≤—Ä–∞—Ç–∞
    markup.add(telebot.types.InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data="back_to_admin"))
    
    bot.edit_message_text(
        "–í—ã–±–µ—Ä–∏—Ç–µ –ø–∞–∫–µ—Ç –∑–≤–µ–∑–¥ –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ü–µ–Ω—ã:",
        message.chat.id,
        message.message_id,
        reply_markup=markup
    )

def show_gifts_menu(message):
    prices = load_prices()
    gifts = prices['gifts']
    
    markup = telebot.types.InlineKeyboardMarkup(row_width=2)
    for gift_key, gift_data in gifts.items():
        button_text = f"{gift_data['name']} - {gift_data['price']}‚ÇΩ"
        callback_data = f"edit_gift_{gift_data['id']}"
        markup.add(telebot.types.InlineKeyboardButton(text=button_text, callback_data=callback_data))
    
    # –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –≤–æ–∑–≤—Ä–∞—Ç–∞
    markup.add(telebot.types.InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data="back_to_admin"))
    
    bot.edit_message_text(
        "–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–¥–∞—Ä–æ–∫ –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ü–µ–Ω—ã:",
        message.chat.id,
        message.message_id,
        reply_markup=markup
    )

def show_premium_menu(message):
    prices = load_prices()
    packages = prices['premium']['packages']
    
    markup = telebot.types.InlineKeyboardMarkup(row_width=2)
    for pkg in packages:
        button_text = f"{pkg['name']} - {pkg['price']}‚ÇΩ"
        callback_data = f"edit_premium_{pkg['id']}"
        markup.add(telebot.types.InlineKeyboardButton(text=button_text, callback_data=callback_data))
    
    # –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –≤–æ–∑–≤—Ä–∞—Ç–∞
    markup.add(telebot.types.InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data="back_to_admin"))
    
    bot.edit_message_text(
        "–í—ã–±–µ—Ä–∏—Ç–µ –ø–∞–∫–µ—Ç Premium –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ü–µ–Ω—ã:",
        message.chat.id,
        message.message_id,
        reply_markup=markup
    )

@bot.callback_query_handler(func=lambda call: call.data == "back_to_admin")
def back_to_admin_menu(call):
    if call.from_user.id != int(os.getenv('ADMIN_ID')):
        bot.answer_callback_query(call.id, "–£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–π —Ñ—É–Ω–∫—Ü–∏–∏")
        return
    
    markup = telebot.types.InlineKeyboardMarkup(row_width=1)
    markup.add(
        telebot.types.InlineKeyboardButton("üí´ –¶–µ–Ω—ã –Ω–∞ –∑–≤–µ–∑–¥—ã", callback_data="menu_stars"),
        telebot.types.InlineKeyboardButton("üéÅ –¶–µ–Ω—ã –Ω–∞ –ø–æ–¥–∞—Ä–∫–∏", callback_data="menu_gifts"),
        telebot.types.InlineKeyboardButton("üëë –¶–µ–Ω—ã –Ω–∞ Premium", callback_data="menu_premium")
    )
    
    bot.edit_message_text(
        "–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–¥–µ–ª –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ü–µ–Ω:",
        call.message.chat.id,
        call.message.message_id,
        reply_markup=markup
    )
    bot.answer_callback_query(call.id)

@bot.callback_query_handler(func=lambda call: call.data.startswith(('edit_stars_', 'edit_gift_', 'edit_premium_')))
def handle_edit_selection(call):
    if call.from_user.id != int(os.getenv('ADMIN_ID')):
        bot.answer_callback_query(call.id, "–£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–π —Ñ—É–Ω–∫—Ü–∏–∏")
        return
    
    try:
        action, item_type, item_id = call.data.split('_')
        prices = load_prices()
        
        if item_type == 'stars':
            stars = int(item_id)
            package = next((pkg for pkg in prices['stars']['packages'] if pkg['stars'] == stars), None)
            if package:
                msg = f"–¢–µ–∫—É—â–∞—è —Ü–µ–Ω–∞ –ø–∞–∫–µ—Ç–∞ {stars} –∑–≤–µ–∑–¥: {package['price']}‚ÇΩ (${package['usd']})\n\n"
                msg += "–û—Ç–ø—Ä–∞–≤—å—Ç–µ –Ω–æ–≤—É—é —Ü–µ–Ω—É –≤ —Ä—É–±–ª—è—Ö."
                bot.send_message(call.message.chat.id, msg)
                bot.register_next_step_handler(call.message, process_new_price, stars=stars)
        
        elif item_type == 'gift':
            gift_id = int(item_id)
            gift = next((data for _, data in prices['gifts'].items() if data['id'] == gift_id), None)
            if gift:
                msg = f"–¢–µ–∫—É—â–∞—è —Ü–µ–Ω–∞ –ø–æ–¥–∞—Ä–∫–∞ '{gift['name']}': {gift['price']}‚ÇΩ\n\n"
                msg += "–û—Ç–ø—Ä–∞–≤—å—Ç–µ –Ω–æ–≤—É—é —Ü–µ–Ω—É –≤ —Ä—É–±–ª—è—Ö."
                bot.send_message(call.message.chat.id, msg)
                bot.register_next_step_handler(call.message, process_new_gift_price, gift_id=gift_id)
        
        elif item_type == 'premium':
            package_id = int(item_id)
            package = next((pkg for pkg in prices['premium']['packages'] if pkg['id'] == package_id), None)
            if package:
                msg = f"–¢–µ–∫—É—â–∞—è —Ü–µ–Ω–∞ –ø–∞–∫–µ—Ç–∞ '{package['name']}': {package['price']}‚ÇΩ\n\n"
                msg += "–û—Ç–ø—Ä–∞–≤—å—Ç–µ –Ω–æ–≤—É—é —Ü–µ–Ω—É –≤ —Ä—É–±–ª—è—Ö."
                bot.send_message(call.message.chat.id, msg)
                bot.register_next_step_handler(call.message, process_new_premium_price, package_id=package_id)
        
        bot.answer_callback_query(call.id)
    
    except Exception as e:
        bot.answer_callback_query(call.id, f"–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: {str(e)}")

def process_new_price(message, stars):
    if message.from_user.id != int(os.getenv('ADMIN_ID')):
        bot.reply_to(message, "–ò–∑–≤–∏–Ω–∏—Ç–µ, —É –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–º—É –±–æ—Ç—É.")
        return
    
    try:
        new_price = float(message.text)
        if new_price <= 0:
            raise ValueError("–¶–µ–Ω–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–º —á–∏—Å–ª–æ–º")
        
        # –ü–æ–ª—É—á–∞–µ–º –∫—É—Ä—Å USD
        usd_rate = get_usd_rate()
        new_usd = round(new_price / usd_rate, 2)
        
        # –û–±–Ω–æ–≤–ª—è–µ–º —Ü–µ–Ω—É
        if update_package_price(stars, new_price, new_usd):
            response = f"‚úÖ –¶–µ–Ω–∞ –ø–∞–∫–µ—Ç–∞ {stars} –∑–≤–µ–∑–¥ –æ–±–Ω–æ–≤–ª–µ–Ω–∞:\n"
            response += f"–ù–æ–≤–∞—è —Ü–µ–Ω–∞: {new_price}‚ÇΩ (${new_usd})"
        else:
            response = "‚ùå –ü–∞–∫–µ—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω"
        
        bot.reply_to(message, response)
    
    except ValueError:
        bot.reply_to(message, "‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Ü–µ–Ω—É (—á–∏—Å–ª–æ –±–æ–ª—å—à–µ –Ω—É–ª—è)")
    except Exception as e:
        bot.reply_to(message, f"‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: {str(e)}")

def process_new_gift_price(message, gift_id):
    if message.from_user.id != int(os.getenv('ADMIN_ID')):
        bot.reply_to(message, "–ò–∑–≤–∏–Ω–∏—Ç–µ, —É –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–º—É –±–æ—Ç—É.")
        return
    
    try:
        new_price = float(message.text)
        if new_price <= 0:
            raise ValueError("–¶–µ–Ω–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–º —á–∏—Å–ª–æ–º")
        
        # –û–±–Ω–æ–≤–ª—è–µ–º —Ü–µ–Ω—É
        if update_gift_price(gift_id, new_price):
            prices = load_prices()
            gift = next((data for _, data in prices['gifts'].items() if data['id'] == gift_id), None)
            response = f"‚úÖ –¶–µ–Ω–∞ –ø–æ–¥–∞—Ä–∫–∞ '{gift['name']}' –æ–±–Ω–æ–≤–ª–µ–Ω–∞:\n"
            response += f"–ù–æ–≤–∞—è —Ü–µ–Ω–∞: {new_price}‚ÇΩ"
        else:
            response = "‚ùå –ü–æ–¥–∞—Ä–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω"
        
        bot.reply_to(message, response)
    
    except ValueError:
        bot.reply_to(message, "‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Ü–µ–Ω—É (—á–∏—Å–ª–æ –±–æ–ª—å—à–µ –Ω—É–ª—è)")
    except Exception as e:
        bot.reply_to(message, f"‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: {str(e)}")

def process_new_premium_price(message, package_id):
    if message.from_user.id != int(os.getenv('ADMIN_ID')):
        bot.reply_to(message, "–ò–∑–≤–∏–Ω–∏—Ç–µ, —É –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–º—É –±–æ—Ç—É.")
        return
    
    try:
        new_price = float(message.text)
        if new_price <= 0:
            raise ValueError("–¶–µ–Ω–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–º —á–∏—Å–ª–æ–º")
        
        # –û–±–Ω–æ–≤–ª—è–µ–º —Ü–µ–Ω—É
        if update_premium_price(package_id, new_price):
            prices = load_prices()
            package = next((pkg for pkg in prices['premium']['packages'] if pkg['id'] == package_id), None)
            response = f"‚úÖ –¶–µ–Ω–∞ –ø–∞–∫–µ—Ç–∞ '{package['name']}' –æ–±–Ω–æ–≤–ª–µ–Ω–∞:\n"
            response += f"–ù–æ–≤–∞—è —Ü–µ–Ω–∞: {new_price}‚ÇΩ"
        else:
            response = "‚ùå –ü–∞–∫–µ—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω"
        
        bot.reply_to(message, response)
    
    except ValueError:
        bot.reply_to(message, "‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Ü–µ–Ω—É (—á–∏—Å–ª–æ –±–æ–ª—å—à–µ –Ω—É–ª—è)")
    except Exception as e:
        bot.reply_to(message, f"‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: {str(e)}")

if __name__ == '__main__':
    # –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
    load_dotenv()
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º Flask —Å–µ—Ä–≤–µ—Ä –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø–æ—Ç–æ–∫–µ
    flask_thread = threading.Thread(target=app.run, kwargs={'host': '0.0.0.0', 'port': 5000})
    flask_thread.daemon = True
    flask_thread.start()
    
    print("–ë–æ—Ç –∑–∞–ø—É—â–µ–Ω! –í–µ–±-—Å–µ—Ä–≤–µ—Ä –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ –∞–¥—Ä–µ—Å—É http://localhost:5000")
    bot.polling()
